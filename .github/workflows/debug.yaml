name: debug

on:
  pull_request_target:
    types:
      - opened
      - synchronize

permissions:
  contents: read
jobs:
  validate-package:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.head_ref }}
    - name: Setup PHP with PECL extension
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
    - name: Validate composer.json and composer.lock
      run: composer validate --strict

    - name: Install dependencies
      run: composer install

    - name: Lint PHP files
      uses: overtrue/phplint@main
      with:
        path: .
        options: --exclude=vendor

    - name: Cache testing env file
      uses: actions/cache@v4
      id: testing-env-cache
      with:
        path: tests/Helpers/.env
        key: ${{ runner.os }}-testing-env-${{ hashFiles('tests/Helpers/.env') }}

    - if: ${{ steps.testing-env-cache.outputs.cache-hit != 'true' }}
      name: Prepare environment file
      env:
        TESTING_ENV_FILE_CONTENT: ${{ secrets.TESTING_ENV_FILE_CONTENT }}
      run: echo $TESTING_ENV_FILE_CONTENT | base64 --decode > tests/Helpers/.env

    - name: Integration tests
      run: composer run-script test
